{% extends 'base.html' %}
{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<div class="layout-container">
  <!-- Sidebar -->
  <div class="sidebar-post">
    <aside class="sidebar">
      <div class="brand">
        <i class="fas fa-utensils"></i>
        <h1>Foodmate</h1>
      </div>
      <ul class="nav-links">
        {% if session['role'] == 'owner' %}
      <li><a href="/restaurant_dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      {% else %}
      <li class="active"><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
      {% endif %}
        {% if session['role'] != 'owner' %}
        <li><a href="/feed"><i class="fas fa-rss"></i> Feed</a></li>
        <li><a href="/upload"><i class="fas fa-plus"></i> Upload</a></li>
        {% endif %}
        <li><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
        <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </aside>
  </div>
  <!-- Main Post Area -->
  <main class="post-main">
    <div class="post-view-container">
      <div class="post-card-standalone">
        <!-- User Header -->
        <div class="post-header">
          <div class="user-row">
            <img src="data:image/jpeg;base64,{{ post.profile_pic }}" class="user-avatar" alt="User">
            <span class="username-feed">{{ post.username }}</span>
            <span class="tag-label">#{{ post.predicted_tag }}</span>
            {% if post.promoted %}
            <span class="promoted-label">‚≠ê Promoted Post</span>
            {% endif %}
          </div>
        </div>

        <!-- Post Image -->
        <div class="post-image-wrap">
          <img src="data:image/png;base64,{{ post.image_base64 }}" alt="Food Image">
        </div>

        <!-- Like and Actions -->
        <div class="post-actions">
          <form action="/like_post/{{ post._id }}" method="POST" style="display:inline;">
            <button type="submit" class="reaction-btn" title="Like">
              üëç <span>{{ post.likes | length if post.likes }}</span>
            </button>
          </form>
        
          <form action="/dislike_post/{{ post._id }}" method="POST" style="display:inline;">
            <button type="submit" class="reaction-btn" title="Dislike">
              üëé <span>{{ post.dislikes | length if post.dislikes }}</span>
            </button>
          </form>
        
        </div>

        <!-- Review -->
        <div class="post-caption">
          <p><strong>{{ post.username }}</strong> </p>
          {% if post.location and post.location.latitude and post.location.longitude %}
          <h4>üìç Location</h4>
          <div id="postMap" style="height: 300px; border-radius: 10px; margin-bottom: 20px;"></div>
          {% endif %}
          <p>{{ post.review }}</p>
        </div>

        <!-- Comment Form -->
        <form method="POST" action="/comment_post/{{ post._id }}" class="comment-form">
          <textarea name="comment" placeholder="Add a comment..." required></textarea>
          <button type="submit">Post</button>
        </form>

        <!-- Comment List -->
        <div class="comments">
          {% for comment in post.comments %}
          <div class="comment-bubble">
            <strong>{{ comment.username }}</strong> {{ comment.text }}
            <small class="timestamp">{{ comment.timestamp }}</small>
            <p class="sentiment-tag">
              {% if comment.sentiment == "Positive" %}
              üòä Positive
              {% elif comment.sentiment == "Negative" %}
              üòû Negative
              {% else %}
              üòê Neutral
              {% endif %}
            </p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </main>
</div>
<script>
  function likePost(event) {
    event.preventDefault();
    const postId = document.getElementById('post_id').value;
    fetch('/like_post/' + postId, { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        const likeBtn = document.getElementById('like-btn');
        const count = document.getElementById('like-count');
        if (data.status === 'liked') {
          likeBtn.textContent = '‚ù§Ô∏è';
          count.textContent = parseInt(count.textContent) + 1;
        } else if (data.status === 'unliked') {
          likeBtn.textContent = 'ü§ç';
          count.textContent = parseInt(count.textContent) - 1;
        }
      });
  }
</script>
{% if post.location and post.location.latitude and post.location.longitude %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var postMapDiv = document.getElementById('postMap');
    if (postMapDiv) {
      const lat = parseFloat('{{ post.location.latitude }}');
      const lng = parseFloat('{{ post.location.longitude }}');
      const map = L.map('postMap').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lng]).addTo(map)
        .bindPopup("This is where the food was eaten.")
        .openPopup();
    }
  });
</script>
{% endif %}

{% endblock %}