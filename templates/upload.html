{% extends 'base.html' %}
{% block content %}
<!-- Leaflet Core CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet Geocoder CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD33LjxMBS6CpJdvFWzDCBSWiE3ZGbPGJU&libraries=places"></script>

<div class="layout-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-utensils"></i>
      <h1>Foodmate</h1>
    </div>
    <ul class="nav-links">
      {% if session['role'] == 'owner' %}
      <li><a href="/restaurant_dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      {% else %}
      <li><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
      {% endif %}
      {% if session['role'] != 'owner' %}
      <li><a href="/feed"><i class="fas fa-rss"></i> Feed</a></li>
      <li class="active"><a href="/upload"><i class="fas fa-plus"></i> Upload</a></li>
      {% endif %}
      <li><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </aside>

  <!-- Upload Page Main -->
  <main class="dashboard-main">
    <h2>Upload a New Food Post</h2>
    <div class="upload-container">
      <!-- Upload Form -->
      <form class="upload-form" method="POST" enctype="multipart/form-data">
        <label>Choose Image:</label>
        <input type="file" name="image" accept="image/*" onchange="previewImage(event)" required>
        <!-- <h4>üìç Select Location (Where you ate this?)</h4>
        <div id="map" style="height: 300px; border-radius: 10px; margin-bottom: 15px;"></div>

        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude"> -->
        <label for="restaurantSearch">Restaurant Location</label>
        <input type="text" id="restaurantSearch" placeholder="Type restaurant or location" class="form-control">

        <!-- Hidden Fields to store selected values -->
        <input type="hidden" name="restaurant_name" id="restaurantName">
        <input type="hidden" name="restaurant_lat" id="restaurantLat">
        <input type="hidden" name="restaurant_lng" id="restaurantLng">

        <!-- Map Preview -->
        <div id="map" style="height: 300px; margin-top: 10px;"></div>

        <label>Write a short review:</label>
        <textarea name="review" placeholder="Describe the food..." oninput="previewReview(event)" required></textarea>

        <button type="submit">Submit Post</button>
      </form>

      <!-- Live Preview -->
      <div class="upload-preview">
        <h4>Post Preview</h4>
        <div class="post-item">
          <img id="preview-img" src="https://cdn-icons-png.flaticon.com/512/2922/2922506.png" alt="Preview">
          <div class="post-content">
            <h4 id="preview-text">Your review will appear here</h4>
            <p class="tag">üç¥ predicted_tag</p>
            <p class="meta"><i class="fas fa-heart"></i> 0 &nbsp; <i class="fas fa-comment"></i> 0</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  function previewImage(event) {
    const output = document.getElementById('preview-img');
    output.src = URL.createObjectURL(event.target.files[0]);
  }
  function previewReview(event) {
    const text = document.getElementById('preview-text');
    text.textContent = event.target.value || "Your review will appear here";
  }
</script>
<!-- Leaflet Core JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet Geocoder JS -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- <script>
  const map = L.map('map').setView([20.5937, 78.9629], 5);  // Default to India

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  let marker;

  function updateCoordinates(lat, lng) {
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;

    if (marker) {
      marker.setLatLng([lat, lng]);
    } else {
      marker = L.marker([lat, lng]).addTo(map);
    }
  }

  // Add geocoder search bar
  const geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
  })
    .on('markgeocode', function (e) {
      const latlng = e.geocode.center;
      map.setView(latlng, 15);
      updateCoordinates(latlng.lat, latlng.lng);
    })
    .addTo(map);

  // Click-to-pin
  map.on('click', function (e) {
    updateCoordinates(e.latlng.lat, e.latlng.lng);
  });
</script> -->
<script>
let map, marker;

function initAutocomplete() {
  const input = document.getElementById("restaurantSearch");
  const autocomplete = new google.maps.places.Autocomplete(input);

  // Restrict results to establishments only
  autocomplete.setTypes(['establishment']);

  // On place selection
  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;

    const name = place.name;
    const lat = place.geometry.location.lat();
    const lng = place.geometry.location.lng();

    // Fill hidden inputs
    document.getElementById("restaurantName").value = name;
    document.getElementById("restaurantLat").value = lat;
    document.getElementById("restaurantLng").value = lng;

    // Show map
    if (!map) {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: { lat: lat, lng: lng }
      });
    } else {
      map.setCenter({ lat: lat, lng: lng });
    }

    // Marker
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({
      position: { lat: lat, lng: lng },
      map: map,
      title: name
    });
  });
}

// Load after window is ready
window.addEventListener('load', initAutocomplete);
</script>


{% endblock %}