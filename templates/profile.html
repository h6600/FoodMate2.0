{% extends 'base.html' %}
{% block content %}
<div class="layout-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-utensils"></i>
      <h1>Foodmate</h1>
    </div>
    <ul class="nav-links">
      {% if session['role'] == 'owner' %}
      <li><a href="/restaurant_dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      {% else %}
      <li class="active"><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
      {% endif %}
      {% if session['role'] != 'owner' %}
      <li><a href="/feed"><i class="fas fa-rss"></i> Feed</a></li>
      <li><a href="/upload"><i class="fas fa-plus"></i> Upload</a></li>
      {% endif %}
      <li class="active"><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </aside>

  <!-- Main Profile Area -->
  <main class="dashboard-main">
    <!-- Profile Header -->
    <section class="profile-header">
      <div class="profile-avatar">
        {% if user.profile_pic %}
        <img src="data:image/png;base64,{{ user.profile_pic }}" alt="Profile Picture" class="rounded-avatar">
        {% else %}
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Default Avatar" class="rounded-avatar">
        {% endif %}
      </div>
      <div class="user-details">
        <h2>{{ user.firstname }} {{ user.lastname }}</h2>
        <p class="bio">{{ user.bio or "Food enthusiast exploring flavors üçπüçï" }}</p>
        <div class="stats">
          <a href="#">üì∏ {{ post_count }} Posts</a>
          <a href="#">‚ù§Ô∏è {{ total_likes }} Likes</a>
          <a href="#">üí¨ {{ total_comments }} Comments</a>
        </div>
      </div>
      <!-- Trigger Button -->
      <button class="btn-edit" onclick="document.getElementById('editModal').style.display='block'">
        ‚úèÔ∏è Edit Profile
      </button>

      <!-- Modal -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
          <h3>Edit Profile</h3>
          <form action="{{ url_for('edit_profile') }}" method="POST" enctype="multipart/form-data">
            <label>First Name</label>
            <input type="text" name="firstname" value="{{ user.firstname }}" required>

            <label>Last Name</label>
            <input type="text" name="lastname" value="{{ user.lastname }}" required>

            <label>Email</label>
            <input type="email" name="email" value="{{ user.email }}" required>

            <label>About</label>
            <textarea name="about">{{ user.about }}</textarea>

            <label>Profile Picture</label>
            <input type="file" name="profile_pic" accept="image/*">

            <button type="submit" id="editProfileBtn" class="btn-save">Save Changes</button>
          </form>
        </div>
      </div>

    </section>

    <!-- User's Posts -->
    <section class="recent-posts">
      <div class="user-posts">
        {% if is_owner %}
        <h3>Posts Tagged with Your Restaurant</h3>
        {% else %}
        <h3>Your Posts</h3>
        {% endif %}

        <div class="posts-grid">
          {% for post in posts %}
          <div class="grid-post" onclick="window.location='/post/{{ post._id }}'">
            <img src="data:image/jpeg;base64,{{ post.image_base64 }}" alt="Post Image" />
            <div class="grid-post-text">
              <strong>{{ post.review }}</strong>
              <p>üç¥ {{ post.predicted_tag }}</p>
              {% if not post.promoted %}
              {% if is_owner %}
              <form action="{{ url_for('promote_post', post_id=post._id) }}" method="POST">
                <button type="submit" class="promote-btn">Promote</button>
              </form>
              {% endif %}
              {% else %}
              <span class="promoted-label">Promoted ‚≠ê</span>
              {% endif %}
              <p>
              <div class="meta-info">
                <form action="/like_post/{{ post._id }}" method="POST" style="display:inline;"
                  onclick="event.stopPropagation();">
                  <button type="submit" class="reaction-btn" title="Like">üëç
                    <span>{{ post.likes|length if post.likes }}</span>
                  </button>
                </form>
                <form action="/dislike_post/{{ post._id }}" method="POST" style="display:inline;"
                  onclick="event.stopPropagation();">
                  <button type="submit" class="reaction-btn" title="Dislike">üëé
                    <span>{{ post.dislikes|length if post.dislikes }}</span>
                  </button>
                </form>
                <i class="fas fa-comment"></i> {{ post.comments|length if post.comments }}
              </div>
              <form method="POST" action="/delete_post/{{ post._id }}"
                onsubmit="return confirm('Are you sure you want to delete this post?');">
                <button type="submit" class="delete-btn" title="Delete Post" onclick="event.stopPropagation();">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

    </section>
  </main>
</div>
<script>
  const modal = document.getElementById("editModal");
  const btn = document.getElementById("editProfileBtn");
  const span = document.querySelector(".modal .close");

  btn.onclick = function () {
    modal.style.display = "block";
  }

  span.onclick = function () {
    modal.style.display = "none";
  }

  window.onclick = function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
</script>
{% endblock %}