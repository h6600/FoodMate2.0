{% extends 'base.html' %}
{% block content %}

<div class="layout-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fas fa-utensils"></i>
      <h1>Foodmate</h1>
    </div>
    <ul class="nav-links">
      {% if session['role'] == 'owner' %}
      <li><a href="/restaurant_dashboard" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      {% else %}
      <li><a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
      {% endif %}
      {% if session['role'] != 'owner' %}
      <li class="active"><a href="/feed"><i class="fas fa-rss"></i> Feed</a></li>
      <li><a href="/upload"><i class="fas fa-plus"></i> Upload</a></li>
      {% endif %}
      <li><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </aside>
  <div id="location-loader" style="display: none;">
    <div class="loader-backdrop">
      <div class="loader-box">
        <p>Finding tasty places nearby...</p>
        <div class="spinner"></div>
      </div>
    </div>
  </div>
  <!-- Main Feed Content -->
  <main class="dashboard-main">
    <div class="feed-header" style="margin-bottom: 0.5rem;">
      <h2 style="margin-bottom: 0.5rem;">Explore Feed</h2>
      <div class="view-toggle" style="display: flex; flex-direction: row; justify-content: flex-end; align-items: center; width: 100%; margin-bottom: 0.5rem; gap: 0.5rem;">
        <form id="locationSearchForm" style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0;">
          <input type="text" id="autocompleteInput" placeholder="Search location (e.g. Airoli)" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; width: 220px;">
          <button type="submit" class="feed-btn" style="padding: 6px 12px;">Search</button>
        </form>
        <div style="display: flex; flex-direction: row; gap: 0.5rem;">
          <button onclick="setFeedView('scroll')" class="feed-btn" id="btn-scroll">üìú Scroll</button>
          <button onclick="setFeedView('grid')" class="feed-btn" id="btn-grid">üî≤ Grid</button>
          <button onclick="seeAllPosts()" class="feed-btn" id="btn-all">See All Posts</button>
        </div>
      </div>
    </div>

    <!-- Feed Container -->
    <div id="feedContainer" class="feed-{{ current_view }}">
      {% for post in all_posts %}
      <div class="feed-post-wrapper">
        <div class="user-row">
          <img src="data:image/jpeg;base64,{{ post.profile_pic }}" class="user-avatar" alt="User">
          <span class="username-feed">{{ post.username }}</span>
        </div>
        <div class="feed-post">
          <a href="/post/{{ post._id }}">
            <img src="data:image/jpeg;base64,{{ post.image_base64 }}" class="post-image" alt="Food Post">
          </a>
          <div class="post-info">
            <h4 class="post-title">{{ post.review }}</h4>
            <p class="tag">üç¥ {{ post.predicted_tag }}</p>
            {% if post.restaurant and post.restaurant.lat and post.restaurant.lng %}
              <h4>üìçRestaurant Name : <strong id="restaurant">{{ post.restaurant.name }}</strong></h4>
            {% endif %}
            {% if post.promoted %}
            <span class="promoted-label">‚≠ê Promoted Post</span>
            {% endif %}
            <div class="meta-info">
              <form action="/like_post/{{ post._id }}" method="POST" style="display:inline;"
                onclick="event.stopPropagation();">
                <button type="submit" class="reaction-btn" title="Like">üëç
                  <span>{{ post.likes|length if post.likes }}</span>
                </button>
              </form>
              <form action="/dislike_post/{{ post._id }}" method="POST" style="display:inline;"
                onclick="event.stopPropagation();">
                <button type="submit" class="reaction-btn" title="Dislike">üëé
                  <span>{{ post.dislikes|length if post.dislikes }}</span>
                </button>
              </form>
              <i class="fas fa-comment"></i> {{ post.comments|length if post.comments }}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination Controls -->
    <div class="pagination">
      {% if current_page > 1 %}
      <a href="{{ url_for('feed', page=current_page-1, view=current_view) }}" class="page-btn">‚Üê Previous</a>
      {% endif %}

      <span class="page-info">Page {{ current_page }} of {{ total_pages }}</span>

      {% if current_page < total_pages %} <a href="{{ url_for('feed', page=current_page+1, view=current_view) }}"
        class="page-btn">Next ‚Üí</a>
        {% endif %}
    </div>

  </main>
</div>

<!-- JS to switch views -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD33LjxMBS6CpJdvFWzDCBSWiE3ZGbPGJU&libraries=places"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('locationSearchForm');
    const autocompleteInput = document.getElementById('autocompleteInput');
    let autocomplete, selectedLatLng = null;
    // Places Autocomplete only
    autocomplete = new google.maps.places.Autocomplete(autocompleteInput);
    autocomplete.setFields(['geometry', 'name']);
    autocomplete.addListener('place_changed', function() {
      const place = autocomplete.getPlace();
      if (!place.geometry || !place.geometry.location) {
        alert('No details available for input: ' + place.name);
        return;
      }
      selectedLatLng = {
        lat: place.geometry.location.lat(),
        lng: place.geometry.location.lng()
      };
    });
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (selectedLatLng) {
          const lat = selectedLatLng.lat;
          const lng = selectedLatLng.lng;
          const urlParams = new URLSearchParams(window.location.search);
          const view = urlParams.get('view') || 'scroll';
          const page = urlParams.get('page') || 1;
          window.location.href = `/feed?lat=${lat}&lng=${lng}&view=${view}&page=${page}`;
          return;
        }
        alert('Please select a valid location from search.');
      });
    }
  });
  function seeAllPosts() {
    const params = new URLSearchParams(window.location.search);
    params.delete('lat');
    params.delete('lng');
    params.set('all', '1');
    window.location.search = params.toString();
  }
  function setFeedView(view) {
    const params = new URLSearchParams(window.location.search);
    params.set('view', view);
    params.set('page', 1);
    window.location.search = params.toString();
  }
</script>
<script>
  // Redirect only if lat/lng not already present in URL
  window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    // If 'all' param is present, skip geolocation redirect
    if (urlParams.has('all')) return;
    if (!urlParams.has('lat') || !urlParams.has('lng')) {
      // Show loader
      document.getElementById('location-loader').style.display = 'block';
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // Preserve view + page from existing URL if present
            const view = urlParams.get('view') || 'scroll';
            const page = urlParams.get('page') || 1;

            const newURL = `/feed?lat=${lat}&lng=${lng}&view=${view}&page=${page}`;
            window.location.replace(newURL);
          },
          function (error) {
            // Hide loader on error
            document.getElementById('location-loader').style.display = 'none';
            console.log("Geolocation failed or denied, showing all posts.");
          }
        );
      } else {
        // Hide loader if geolocation not available
        document.getElementById('location-loader').style.display = 'none';
      }
    }
  });
</script>




<style>
  .post-wrapper.grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .post-wrapper.scroll {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .post-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: 0.3s;
  }

  .post-card:hover {
    transform: translateY(-3px);
  }

  .post-wrapper.grid .post-card {
    width: 300px;
  }

  .post-wrapper.scroll .post-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 10px;
  }

  .post-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .post-wrapper.scroll .post-image {
    width: 200px;
    height: 150px;
    flex-shrink: 0;
  }

  .post-info {
    padding: 10px;
  }

  .post-wrapper.scroll .post-info {
    padding: 0;
  }

  .post-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px;
  }

  .tag {
    font-size: 14px;
    color: #555;
  }

  .post-meta {
    font-size: 13px;
    color: #888;
    margin-top: 8px;
  }

  .feed-scroll .feed-post {
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: center;
    background-color: #fff;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
  }

  .feed-scroll .feed-post>img {
    width: 150px;
    height: 150px;
    border-radius: 8px;
    object-fit: cover;
  }

  .feed-scroll .feed-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .feed-scroll .feed-text h4 {
    margin: 0 0 8px;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .feed-scroll .feed-text .tag {
    font-size: 0.9rem;
    color: #888;
    margin-bottom: 8px;
  }

  .feed-scroll .feed-text .meta {
    font-size: 0.85rem;
    color: #666;
  }

  /* Default shared post style */
  .feed-post {
    background-color: #fff;
    border-radius: 12px;
    cursor: pointer;
    overflow: hidden;
  }

  /* SCROLL MODE */
  .feed-scroll .feed-post {
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: center;
  }

  .feed-scroll .feed-post img {
    width: 150px;
    height: 150px;
    border-radius: 8px;
    object-fit: cover;
  }

  .feed-scroll .feed-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* GRID MODE */
  .feed-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    padding: 20px;
  }

  .feed-grid .feed-post {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .feed-grid .feed-post img {
    width: 100%;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
  }

  .feed-grid .feed-text {
    padding-top: 10px;
    width: 100%;
  }

  .meta-info {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
 }
 .loader-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.9);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}
.loader-box {
  text-align: center;
}
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #ff6347;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  margin: 20px auto;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>

{% endblock %}